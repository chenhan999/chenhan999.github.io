# Sentinel

官方文档地址：[《https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D》]

Sentinel 以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性。

本次项目集成调研，主要学习两个方向的使用：

## 1.通过资源或者URL进行流控
### 1.1pom添加
	<!--springCloud整合sentinel 支持YML中做配置-->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
            <version>1.5.1.RELEASE</version>
        </dependency>
        <!--nacos作为持久层保存资源规则-->
        <dependency>
            <groupId>com.alibaba.csp</groupId>
            <artifactId>sentinel-datasource-nacos</artifactId>
            <version>1.6.3</version>
        </dependency>
        <dependency>
            <groupId>com.alibaba.csp</groupId>
            <artifactId>sentinel-core</artifactId>
            <version>1.6.3</version>
        </dependency>
        <!--应用端与控制台通信-->
        <dependency>
            <groupId>com.alibaba.csp</groupId>
            <artifactId>sentinel-transport-simple-http</artifactId>
            <version>1.6.3</version>
        </dependency>
        <!--支持注解-->
        <dependency>
            <groupId>com.alibaba.csp</groupId>
            <artifactId>sentinel-annotation-aspectj</artifactId>
            <version>1.6.3</version>
        </dependency>

### 2.2应用端配置文件添加

sentinel:    
    transport:
        port: 8721                                           #应用端与控制台通信端口
        dashboard: localhost:8080                            #控制台
    datasource:
        ds:
            nacos:
                server-addr: 10.157.109.30:8848             #nacos 规则存放地址
                dataId: ${spring.application.name}-flow-rules
                groupId: SENTINEL_GROUP
                ruleType: flow
                dataType: json
                namespace: 17be4b44-6c1e-4345-bc00-3137e494e568



### 2.3下载dashboard控制台进行管理

[《下载点我 ^-^ 》](https://github.com/alibaba/Sentinel/tree/master/sentinel-dashboar346d)

流控规则默认储存在应用端内存，应用重启规则全部消失，需要对控制台进行改造，实现推模式利用nacos实现规则持久化

控制台改造教程：https://blog.csdn.net/weixin_34159110/article/details/91431633?utm_source=distribute.pc_relevant.none-task   （还需在NacosConfig中配置NAMESPACE）

使用改造后的控制台，创建的流控规则并不生效，因为默认拉取规则的数据源还是内存，需要在应用端进行数据源配置

```
@Configuration
public class DataSourceInitConfig {

    Logger logger = LoggerFactory.getLogger(DataSourceInitConfig.class);

    @Autowired
    private SentinelProperties sentinelProperties;

    @Bean
    public DataSourceInitConfig init() throws Exception {

        logger.info("[NacosSource初始化,从Nacos中获取熔断规则]");

        sentinelProperties.getDatasource().entrySet().stream().filter(map -> {
            return map.getValue().getNacos() != null;
        }).forEach(map -> {
            NacosDataSourceProperties nacos = map.getValue().getNacos();
            ReadableDataSource<String, List<FlowRule>> flowRuleDataSource = new NacosDataSource<>(nacos.getServerAddr(),
                    nacos.getGroupId(), nacos.getDataId(),
                    source -> JSON.parseObject(source, new TypeReference<List<FlowRule>>() {
                    }));
            FlowRuleManager.register2Property(flowRuleDataSource.getProperty());
        });
        return new DataSourceInitConfig();
    }
}
```
配置之后，从nacos拉取的规则会存到内存中


## 2.集成SpringGateWay对网关进行流控

### 2.1 pom添加
	    <!--getway集成-->
		<dependency>
			<groupId>com.alibaba.csp</groupId>
			<artifactId>sentinel-spring-cloud-gateway-adapter</artifactId>
			<version>1.6.0</version>
		</dependency>

注： 在gateWay服务中使用1.5.1.RELEASE版本的spring-cloud-starter-alibaba-sentinel会导致服务无法正常启动，具体原因尚未查明，测试2.0.0.RELEASE版本能正常使用

### 2.2 添加GatewayConfiguration配置类
```
@Configuration
public class GatewayConfiguration {

    private final List<ViewResolver> viewResolvers;
    private final ServerCodecConfigurer serverCodecConfigurer;

    public GatewayConfiguration(ObjectProvider<List<ViewResolver>> viewResolversProvider,
                                ServerCodecConfigurer serverCodecConfigurer) {
        this.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList);
        this.serverCodecConfigurer = serverCodecConfigurer;
    }

    @Bean
    @Order(Ordered.HIGHEST_PRECEDENCE)
    public SentinelGatewayBlockExceptionHandler sentinelGatewayBlockExceptionHandler() {
        // Register the block exception handler for Spring Cloud Gateway.
        return new SentinelGatewayBlockExceptionHandler(viewResolvers, serverCodecConfigurer);
    }

    @Bean
    @Order(Ordered.HIGHEST_PRECEDENCE)
    public GlobalFilter sentinelGatewayFilter() {
        return new SentinelGatewayFilter();
    }
}
```
### 2.3 在gateway应用端启动参数添加 -Dcsp.sentinel.app.type=1（应该可以通过配置文件配置，具体配置查阅官方文档）

配置此参数之后，在控制台会展示针对gateway特有的管理页面，此功能在控制台版本1.6.3之后才有

注：控制台版本release-1.7分支无法支持1.6.3的sentinel，页面上会报错，下载控制台的时候选择release-1.6分支即可



测试使用下来，感觉有待修改的地方：

1.簇点链路页面中新增的流控规则，调用的是V1接口，无法直接存到nacos中，尝试修改前端？

2.控制台NacosConfig需要配置namespace，server_addr,感觉不太灵活，切换环境都需要重新修改源码
